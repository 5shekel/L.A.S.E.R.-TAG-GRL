name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            os_name: ubuntu22.04
          - os: ubuntu-24.04
            os_name: ubuntu24.04
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache openFrameworks + addons
        uses: actions/cache@v4
        id: cache-of
        with:
          path: |
            laser-tag-2026/lib/of_v0.12.1_linux64_gcc6_release
          key: of-linux-0.12.1-${{ matrix.os_name }}-v2

      - name: Download openFrameworks
        if: steps.cache-of.outputs.cache-hit != 'true'
        run: |
          cd laser-tag-2026
          mkdir -p lib && cd lib
          curl -sfSL -o of.tar.gz https://github.com/openframeworks/openFrameworks/releases/download/0.12.1/of_v0.12.1_linux64_gcc6_release.tar.gz
          tar -xzf of.tar.gz
          rm of.tar.gz
          # Install addons into OF directory (will be cached)
          cd of_v0.12.1_linux64_gcc6_release/addons
          git clone --depth 1 https://github.com/frauzufall/ofxGuiExtended.git
          git clone --depth 1 https://github.com/kylemcdonald/ofxCv.git

      - name: Install OF dependencies
        run: |
          sudo apt-get update
          # Install libunwind-dev first (required by gstreamer)
          sudo apt-get install -y libunwind-dev
          cd laser-tag-2026/lib/of_v0.12.1_linux64_gcc6_release/scripts/linux/ubuntu
          yes | sudo ./install_dependencies.sh || true

      - name: Cache build objects
        uses: actions/cache@v4
        with:
          path: |
            laser-tag-2026/obj
            laser-tag-2026/lib/of_v0.12.1_linux64_gcc6_release/libs/openFrameworksCompiled/lib
          key: build-linux-${{ matrix.os_name }}-${{ hashFiles('laser-tag-2026/src/**') }}
          restore-keys: |
            build-linux-${{ matrix.os_name }}-

      - name: Update config.make for Linux
        run: |
          cd laser-tag-2026
          sed -i 's|OF_ROOT = lib/of_v0.12.1_osx_release|OF_ROOT = lib/of_v0.12.1_linux64_gcc6_release|' config.make

      - name: Patch ofxCv for GCC
        run: |
          cd laser-tag-2026/local_addons/ofxCv/libs/ofxCv/include/ofxCv
          sed -i 's/Tracker<T>()/Tracker()/' Tracker.h

      - name: Patch OF for missing memory header
        run: |
          cd laser-tag-2026/lib/of_v0.12.1_linux64_gcc6_release/libs/openFrameworks/types
          sed -i '1i #include <memory>' ofTypes.h

      - name: Build
        run: |
          cd laser-tag-2026
          make Release -j$(nproc)

      - name: Package as Debian package
        run: |
          cd laser-tag-2026
          VERSION=$(date +%Y.%m.%d)
          PKG_DIR=laser-tag-2026_${VERSION}_amd64

          # Create debian package structure
          mkdir -p ${PKG_DIR}/DEBIAN
          mkdir -p ${PKG_DIR}/usr/bin
          mkdir -p ${PKG_DIR}/usr/share/laser-tag-2026
          mkdir -p ${PKG_DIR}/usr/share/applications
          mkdir -p ${PKG_DIR}/usr/share/icons/hicolor/256x256/apps

          # Copy binary and data
          cp bin/laser-tag-2026 ${PKG_DIR}/usr/bin/
          cp -r bin/data ${PKG_DIR}/usr/share/laser-tag-2026/

          # Create wrapper script that sets working directory
          cat > ${PKG_DIR}/usr/bin/laser-tag-2026-launcher << 'LAUNCHER'
          #!/bin/bash
          cd /usr/share/laser-tag-2026
          exec /usr/bin/laser-tag-2026 "$@"
          LAUNCHER
          chmod +x ${PKG_DIR}/usr/bin/laser-tag-2026-launcher

          # Create desktop entry
          cat > ${PKG_DIR}/usr/share/applications/laser-tag-2026.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=Laser Tag 2026
          Comment=Interactive laser graffiti installation
          Exec=laser-tag-2026-launcher
          Terminal=false
          Type=Application
          Categories=Graphics;Art;
          DESKTOP

          # Dynamically detect OpenCV package suffix for this Ubuntu version
          OPENCV_SUFFIX=$(apt-cache search '^libopencv-core[0-9]' | head -1 | grep -oP 'libopencv-core\K[0-9.d]+')
          echo "Detected OpenCV suffix: ${OPENCV_SUFFIX}"

          # Create control file with dynamically detected OpenCV dependencies
          cat > ${PKG_DIR}/DEBIAN/control << CONTROL
          Package: laser-tag-2026
          Version: ${VERSION}
          Section: graphics
          Priority: optional
          Architecture: amd64
          Depends: libopencv-core${OPENCV_SUFFIX}, libopencv-imgproc${OPENCV_SUFFIX}, libopencv-video${OPENCV_SUFFIX}, libopencv-videoio${OPENCV_SUFFIX}, libglfw3, libfreeimage3, libpugixml1v5, liburiparser1, libgstreamer1.0-0, libgstreamer-plugins-base1.0-0, libasound2, libpulse0, libgtk-3-0, libcurl4
          Maintainer: GRL <info@graffitiresearchlab.com>
          Description: Laser Tag 2026 - Interactive laser graffiti
           An interactive art installation that uses computer vision
           to track laser pointers, allowing users to paint on
           projected surfaces using lasers as brushes.
          CONTROL

          # Build the package with OS-specific name
          dpkg-deb --build ${PKG_DIR}
          mv ${PKG_DIR}.deb bin/laser-tag-2026-${{ matrix.os_name }}.deb

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build-${{ matrix.os_name }}
          path: laser-tag-2026/bin/laser-tag-2026-${{ matrix.os_name }}.deb

  build-macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache openFrameworks + addons
        uses: actions/cache@v4
        id: cache-of
        with:
          path: |
            laser-tag-2026/lib/of_v0.12.1_osx_release
          key: of-macos-0.12.1-v2

      - name: Download openFrameworks
        if: steps.cache-of.outputs.cache-hit != 'true'
        run: |
          cd laser-tag-2026
          mkdir -p lib && cd lib
          curl -sfSL -o of.tar.gz https://github.com/openframeworks/openFrameworks/releases/download/0.12.1/of_v0.12.1_osx_release.tar.gz
          tar -xzf of.tar.gz
          rm of.tar.gz
          # Install addons into OF directory (will be cached)
          cd of_v0.12.1_osx_release/addons
          git clone --depth 1 https://github.com/frauzufall/ofxGuiExtended.git
          git clone --depth 1 https://github.com/kylemcdonald/ofxCv.git

      - name: Cache build objects
        uses: actions/cache@v4
        with:
          path: |
            laser-tag-2026/obj
            laser-tag-2026/lib/of_v0.12.1_osx_release/libs/openFrameworksCompiled/lib
          key: build-macos-${{ hashFiles('laser-tag-2026/src/**') }}
          restore-keys: |
            build-macos-

      - name: Build
        run: |
          cd laser-tag-2026
          make Release -j$(sysctl -n hw.ncpu)

      - name: Package
        run: |
          cd laser-tag-2026/bin
          zip -r laser-tag-2026-macos.zip laser-tag-2026.app data/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: laser-tag-2026/bin/laser-tag-2026-macos.zip

  build-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache openFrameworks + addons
        uses: actions/cache@v4
        id: cache-of
        with:
          path: |
            laser-tag-2026/lib/of_v0.12.1_vs_64_release
          key: of-windows-0.12.1-v3

      - name: Download openFrameworks
        if: steps.cache-of.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          cd laser-tag-2026
          New-Item -ItemType Directory -Force -Path lib
          cd lib
          Invoke-WebRequest -Uri "https://github.com/openframeworks/openFrameworks/releases/download/0.12.1/of_v0.12.1_vs_64_release.zip" -OutFile "of.zip"
          Expand-Archive -Path of.zip -DestinationPath .
          Remove-Item of.zip
          # Install addons into OF directory (will be cached)
          cd of_v0.12.1_vs_64_release/addons
          git clone --depth 1 https://github.com/frauzufall/ofxGuiExtended.git
          git clone --depth 1 https://github.com/kylemcdonald/ofxCv.git

      - name: Cache build objects
        uses: actions/cache@v4
        with:
          path: |
            laser-tag-2026/obj
            laser-tag-2026/lib/of_v0.12.1_vs_64_release/libs/openFrameworksCompiled/lib
          key: build-windows-${{ hashFiles('laser-tag-2026/src/**') }}
          restore-keys: |
            build-windows-

      - name: Create dll directory
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path laser-tag-2026/dll/x64

      - name: Build
        shell: cmd
        run: |
          cd laser-tag-2026
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe" laser-tag-2026.sln /p:Configuration=Release /p:Platform=x64 /m

      - name: Package
        shell: powershell
        run: |
          cd laser-tag-2026/bin
          Compress-Archive -Path laser-tag-2026.exe,data -DestinationPath laser-tag-2026-windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: laser-tag-2026/bin/laser-tag-2026-windows.zip

  release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-build-ubuntu22.04/laser-tag-2026-ubuntu22.04.deb
            linux-build-ubuntu24.04/laser-tag-2026-ubuntu24.04.deb
            macos-build/laser-tag-2026-macos.zip
            windows-build/laser-tag-2026-windows.zip
          generate_release_notes: true
          body: |
            ## Installation Notes

            ### macOS
            After downloading and extracting the zip, macOS may show "app is damaged" or block the app from opening. Run the following command in Terminal to fix this:
            ```bash
            xattr -cr /path/to/laser-tag-2026.app
            ```
            Then extract the zip again - the `data/` folder must be in the same directory as the `.app` bundle.

            ### Windows
            Extract the zip and run `laser-tag-2026.exe`. The `data/` folder must be in the same directory as the executable.

            ### Linux (Debian/Ubuntu)
            Choose the deb matching your Ubuntu version:
            - `laser-tag-2026-ubuntu22.04.deb` - For Ubuntu 22.04 LTS (OpenCV 4.5)
            - `laser-tag-2026-ubuntu24.04.deb` - For Ubuntu 24.04 LTS (OpenCV 4.6)
            
            For Ubuntu 25.x users: Use the 24.04 deb and add the Noble repository:
            ```bash
            # Add Ubuntu 24.04 repo for OpenCV 4.6
            echo "deb [arch=amd64] http://archive.ubuntu.com/ubuntu noble main universe" | sudo tee /etc/apt/sources.list.d/noble-opencv.list
            sudo apt update
            ```
            
            Install:
            ```bash
            sudo dpkg -i laser-tag-2026-ubuntu*.deb
            sudo apt-get install -f  # Install dependencies
            laser-tag-2026-launcher
            ```
