name: Windows Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Cache 1: Downloaded OF (before any compilation)
      - name: Cache OF download
        id: cache-of-download
        uses: actions/cache@v4
        with:
          path: C:\of-download
          key: of-0.12.1-vs64-download
          save-always: true

      - name: Download openFrameworks
        if: steps.cache-of-download.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          Write-Host "Downloading openFrameworks..."
          Invoke-WebRequest -Uri "https://github.com/openframeworks/openFrameworks/releases/download/0.12.1/of_v0.12.1_vs_64_release.zip" -OutFile "of.zip"
          Write-Host "Extracting to cache location..."
          Expand-Archive -Path "of.zip" -DestinationPath "C:\"
          Rename-Item "C:\of_v0.12.1_vs_64_release" "C:\of-download"

      # Cache 2: Fully built OF with addons
      - name: Cache OF compiled
        id: cache-of-compiled
        uses: actions/cache@v4
        with:
          path: C:\of
          key: of-0.12.1-vs64-compiled-v5
          restore-keys: |
            of-0.12.1-vs64-compiled-
          save-always: true

      - name: Setup OF from download cache
        if: steps.cache-of-compiled.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          Write-Host "Copying OF from download cache..."
          if (Test-Path "C:\of") { Remove-Item -Recurse -Force "C:\of" }
          Copy-Item -Path "C:\of-download" -Destination "C:\of" -Recurse

      - name: Clone ofxCv addon
        if: steps.cache-of-compiled.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          cd C:\of\addons
          if (-not (Test-Path "ofxCv")) {
            git clone --depth 1 https://github.com/kylemcdonald/ofxCv.git
          }

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build openFrameworks library
        if: steps.cache-of-compiled.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          cd C:\of\libs\openFrameworksCompiled\project\vs
          msbuild openframeworksLib.vcxproj /p:Configuration=Release /p:Platform=x64 /m

      # Project-specific steps (always run)
      - name: Copy project to OF apps folder
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "C:\of\apps\myApps\LaserTag2020"

          # Copy source and config files
          Copy-Item -Path "${{ github.workspace }}\LaserTag2020\src" -Destination "C:\of\apps\myApps\LaserTag2020\src" -Recurse -Force
          Copy-Item -Path "${{ github.workspace }}\LaserTag2020\bin" -Destination "C:\of\apps\myApps\LaserTag2020\bin" -Recurse -Force
          Copy-Item -Path "${{ github.workspace }}\LaserTag2020\addons.make" -Destination "C:\of\apps\myApps\LaserTag2020\addons.make" -Force

          # Copy patched ofxGuiExtended from local_addons to OF addons
          if (Test-Path "${{ github.workspace }}\LaserTag2020\local_addons\ofxGuiExtended") {
            Write-Host "Using patched ofxGuiExtended from local_addons"
            if (Test-Path "C:\of\addons\ofxGuiExtended") {
              Remove-Item -Recurse -Force "C:\of\addons\ofxGuiExtended"
            }
            Copy-Item -Path "${{ github.workspace }}\LaserTag2020\local_addons\ofxGuiExtended" -Destination "C:\of\addons\ofxGuiExtended" -Recurse
          }

      - name: Generate Visual Studio project
        shell: powershell
        run: |
          cd C:\of
          $pgPath = "C:\of\projectGenerator\projectGenerator.exe"

          if (Test-Path $pgPath) {
            Write-Host "Running Project Generator..."
            & $pgPath -o"C:\of" -p"vs" "C:\of\apps\myApps\LaserTag2020"
          } else {
            Write-Host "ERROR: Project Generator not found"
            Get-ChildItem "C:\of" -Directory | Select-Object Name
            exit 1
          }

      - name: Fix include paths for nested source structure
        shell: powershell
        run: |
          cd C:\of\apps\myApps\LaserTag2020

          # OF Project Generator doesn't handle nested src/ directories well
          # We need to add include paths for src/app, src/dataIn, src/dataOut, src/utils
          $vcxproj = Get-Content "LaserTag2020.vcxproj" -Raw

          # Find existing AdditionalIncludeDirectories and add our paths
          $srcDirs = "src\app;src\dataIn;src\dataOut;src\utils;"

          # Add to both Debug and Release configs
          $vcxproj = $vcxproj -replace '(<AdditionalIncludeDirectories>)', "`$1$srcDirs"

          Set-Content "LaserTag2020.vcxproj" $vcxproj
          Write-Host "Added include paths for nested source directories"

      - name: Build LaserTag2020
        shell: powershell
        run: |
          cd C:\of\apps\myApps\LaserTag2020

          if (-not (Test-Path "LaserTag2020.vcxproj")) {
            Write-Host "ERROR: LaserTag2020.vcxproj not found!"
            Get-ChildItem
            exit 1
          }

          msbuild LaserTag2020.vcxproj /p:Configuration=Release /p:Platform=x64 /m

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: LaserTag2020-Windows
          path: C:\of\apps\myApps\LaserTag2020\bin\**
          retention-days: 7

      - name: Report build status
        if: always()
        shell: powershell
        run: |
          Write-Host "Build completed."
          Write-Host "Cache status - Download: ${{ steps.cache-of-download.outputs.cache-hit }}, Compiled: ${{ steps.cache-of-compiled.outputs.cache-hit }}"
