name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache openFrameworks + addons
        uses: actions/cache@v4
        id: cache-of
        with:
          path: |
            laser-tag-2026/lib/of_v0.12.1_linux64_gcc6_release
          key: of-linux-0.12.1-v2

      - name: Download openFrameworks
        if: steps.cache-of.outputs.cache-hit != 'true'
        run: |
          cd laser-tag-2026
          mkdir -p lib && cd lib
          curl -sfSL -o of.tar.gz https://github.com/openframeworks/openFrameworks/releases/download/0.12.1/of_v0.12.1_linux64_gcc6_release.tar.gz
          tar -xzf of.tar.gz
          rm of.tar.gz
          # Install addons into OF directory (will be cached)
          cd of_v0.12.1_linux64_gcc6_release/addons
          git clone --depth 1 https://github.com/LeonFedotov/ofxGuiExtended.git -b of-0.12-compatibility
          git clone --depth 1 https://github.com/kylemcdonald/ofxCv.git

      - name: Install OF dependencies
        run: |
          sudo apt-get update
          # Install libunwind-dev first (required by gstreamer)
          sudo apt-get install -y libunwind-dev
          cd laser-tag-2026/lib/of_v0.12.1_linux64_gcc6_release/scripts/linux/ubuntu
          yes | sudo ./install_dependencies.sh || true

      - name: Cache build objects
        uses: actions/cache@v4
        with:
          path: |
            laser-tag-2026/obj
            laser-tag-2026/lib/of_v0.12.1_linux64_gcc6_release/libs/openFrameworksCompiled/lib
          key: build-linux-${{ hashFiles('laser-tag-2026/src/**') }}
          restore-keys: |
            build-linux-

      - name: Update config.make for Linux
        run: |
          cd laser-tag-2026
          sed -i 's|OF_ROOT = lib/of_v0.12.1_osx_release|OF_ROOT = lib/of_v0.12.1_linux64_gcc6_release|' config.make

      - name: Patch ofxCv for GCC
        run: |
          cd laser-tag-2026/local_addons/ofxCv/libs/ofxCv/include/ofxCv
          sed -i 's/Tracker<T>()/Tracker()/' Tracker.h

      - name: Patch OF for missing memory header
        run: |
          cd laser-tag-2026/lib/of_v0.12.1_linux64_gcc6_release/libs/openFrameworks/types
          sed -i '1i #include <memory>' ofTypes.h

      - name: Build
        run: |
          cd laser-tag-2026
          make Release -j$(nproc)

      - name: Package
        run: |
          cd laser-tag-2026/bin
          mkdir -p libs
          # Bundle OpenCV and other required libraries
          ldd laser-tag-2026 | grep "=> /" | awk '{print $3}' | while read lib; do
            # Copy OpenCV, OpenFrameworks, and other non-system libs
            case "$lib" in
              */libopencv*|*/libof*|*/libfreeimage*|*/libpugixml*|*/liburiparser*|*/libglfw*)
                cp -L "$lib" libs/
                ;;
            esac
          done
          # Create launcher script
          cat > run.sh << 'LAUNCHER'
          #!/bin/bash
          DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export LD_LIBRARY_PATH="$DIR/libs:$LD_LIBRARY_PATH"
          exec "$DIR/laser-tag-2026" "$@"
          LAUNCHER
          chmod +x run.sh
          tar -czvf laser-tag-2026-linux.tar.gz laser-tag-2026 run.sh libs/ data/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: laser-tag-2026/bin/laser-tag-2026-linux.tar.gz

  build-macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache openFrameworks + addons
        uses: actions/cache@v4
        id: cache-of
        with:
          path: |
            laser-tag-2026/lib/of_v0.12.1_osx_release
          key: of-macos-0.12.1-v2

      - name: Download openFrameworks
        if: steps.cache-of.outputs.cache-hit != 'true'
        run: |
          cd laser-tag-2026
          mkdir -p lib && cd lib
          curl -sfSL -o of.tar.gz https://github.com/openframeworks/openFrameworks/releases/download/0.12.1/of_v0.12.1_osx_release.tar.gz
          tar -xzf of.tar.gz
          rm of.tar.gz
          # Install addons into OF directory (will be cached)
          cd of_v0.12.1_osx_release/addons
          git clone --depth 1 https://github.com/LeonFedotov/ofxGuiExtended.git -b of-0.12-compatibility
          git clone --depth 1 https://github.com/kylemcdonald/ofxCv.git

      - name: Cache build objects
        uses: actions/cache@v4
        with:
          path: |
            laser-tag-2026/obj
            laser-tag-2026/lib/of_v0.12.1_osx_release/libs/openFrameworksCompiled/lib
          key: build-macos-${{ hashFiles('laser-tag-2026/src/**') }}
          restore-keys: |
            build-macos-

      - name: Build
        run: |
          cd laser-tag-2026
          make Release -j$(sysctl -n hw.ncpu)

      - name: Package
        run: |
          cd laser-tag-2026/bin
          zip -r laser-tag-2026-macos.zip laser-tag-2026.app data/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: laser-tag-2026/bin/laser-tag-2026-macos.zip

  build-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache openFrameworks + addons
        uses: actions/cache@v4
        id: cache-of
        with:
          path: |
            laser-tag-2026/lib/of_v0.12.1_vs_64_release
          key: of-windows-0.12.1-v3

      - name: Download openFrameworks
        if: steps.cache-of.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          cd laser-tag-2026
          New-Item -ItemType Directory -Force -Path lib
          cd lib
          Invoke-WebRequest -Uri "https://github.com/openframeworks/openFrameworks/releases/download/0.12.1/of_v0.12.1_vs_64_release.zip" -OutFile "of.zip"
          Expand-Archive -Path of.zip -DestinationPath .
          Remove-Item of.zip
          # Install addons into OF directory (will be cached)
          cd of_v0.12.1_vs_64_release/addons
          git clone --depth 1 https://github.com/LeonFedotov/ofxGuiExtended.git -b of-0.12-compatibility
          git clone --depth 1 https://github.com/kylemcdonald/ofxCv.git

      - name: Cache build objects
        uses: actions/cache@v4
        with:
          path: |
            laser-tag-2026/obj
            laser-tag-2026/lib/of_v0.12.1_vs_64_release/libs/openFrameworksCompiled/lib
          key: build-windows-${{ hashFiles('laser-tag-2026/src/**') }}
          restore-keys: |
            build-windows-

      - name: Create dll directory
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path laser-tag-2026/dll/x64

      - name: Build
        shell: cmd
        run: |
          cd laser-tag-2026
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe" laser-tag-2026.sln /p:Configuration=Release /p:Platform=x64 /m

      - name: Package
        shell: powershell
        run: |
          cd laser-tag-2026/bin
          Compress-Archive -Path laser-tag-2026.exe,data -DestinationPath laser-tag-2026-windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: laser-tag-2026/bin/laser-tag-2026-windows.zip

  release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux-build/laser-tag-2026-linux.tar.gz
            macos-build/laser-tag-2026-macos.zip
            windows-build/laser-tag-2026-windows.zip
          generate_release_notes: true
          body: |
            ## Installation Notes

            ### macOS
            After downloading and extracting the zip, macOS may show "app is damaged" or block the app from opening. Run the following command in Terminal to fix this:
            ```bash
            xattr -cr /path/to/laser-tag-2026.app
            ```
            Then extract the zip again - the `data/` folder must be in the same directory as the `.app` bundle.

            ### Windows
            Extract the zip and run `laser-tag-2026.exe`. The `data/` folder must be in the same directory as the executable.

            ### Linux
            Extract the tarball and run `./run.sh` (this sets up library paths). The `data/` folder must be in the same directory.
